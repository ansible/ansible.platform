---
- name: Generate a test ID
  ansible.builtin.set_fact:
    test_id: "{{ lookup('password', '/dev/null chars=ascii_letters length=16') }}"
  when: test_id is not defined

- name: Preset vars
  ansible.builtin.set_fact:
    name_prefix: "GW-Collection-Test-CA-Certs-{{ test_id }}"

- name: Run Test
  module_defaults:
    group/ansible.platform.gateway:
      gateway_hostname: "{{ gateway_hostname }}"
      gateway_username: "{{ gateway_username }}"
      gateway_password: "{{ gateway_password }}"
      gateway_validate_certs: "{{ gateway_validate_certs | bool }}"

  block:
    - name: Create CA Certificate
      ansible.platform.ca_certificate:
        name: "{{ name_prefix }}-Test-Cert"
        pem_data: "{{ lookup('file', 'test_cert.pem') }}"
        state: present
      register: create_result

    - name: Verify CA Certificate was created
      ansible.builtin.assert:
        that:
          - create_result.changed
          - create_result.id is defined

    - name: Get CA Certificate
      ansible.platform.ca_certificate:
        name: "{{ name_prefix }}-Test-Cert"
        state: exists
      register: get_result

    - name: Verify CA Certificate exists
      ansible.builtin.assert:
        that:
          - not get_result.changed
          - get_result.id == create_result.id

    - name: Delete CA Certificate
      ansible.platform.ca_certificate:
        name: "{{ name_prefix }}-Test-Cert"
        state: absent
      register: delete_result

    - name: Verify CA Certificate was deleted
      ansible.builtin.assert:
        that:
          - delete_result.changed
          - delete_result.id is not defined

  always:
    - name: Cleanup - Delete CA Certificate if still exists
      ansible.platform.ca_certificate:
        name: "{{ name_prefix }}-Test-Cert"
        state: absent
      register: cleanup_result
      failed_when: false
...
